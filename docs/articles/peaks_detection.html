<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>QC analysis via peaks detection • CNAqc</title>
<!-- favicons --><link rel="icon" type="image/png" sizes="16x16" href="../favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="../favicon-32x32.png">
<link rel="apple-touch-icon" type="image/png" sizes="180x180" href="../apple-touch-icon.png">
<link rel="apple-touch-icon" type="image/png" sizes="120x120" href="../apple-touch-icon-120x120.png">
<link rel="apple-touch-icon" type="image/png" sizes="76x76" href="../apple-touch-icon-76x76.png">
<link rel="apple-touch-icon" type="image/png" sizes="60x60" href="../apple-touch-icon-60x60.png">
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js" integrity="sha256-FgpCb/KJQlLNfOu91ta32o/NMZxltwRo8QtmkMRdAu8=" crossorigin="anonymous"></script><!-- Bootstrap --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.3.7/css/bootstrap.min.css" integrity="sha256-916EbMg70RQy9LHiGkXzG8hSg9EdNy97GazNG/aiY1w=" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha256-U5ZEeKfGNOja007MMD3YBI0A3OSZOQbeG6z2f2Y0hu8=" crossorigin="anonymous"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.7.1/css/all.min.css" integrity="sha256-nAmazAk6vS34Xqo0BSrTb+abbtFlgsFK7NKSi6o7Y78=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.7.1/css/v4-shims.min.css" integrity="sha256-6qHlizsOWFskGlwVOKuns+D1nB6ssZrHQrNj1wGplHc=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.4/clipboard.min.js" integrity="sha256-FiZwavyI2V6+EXO1U+xzLG3IKldpiTFf3153ea9zikQ=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.9.4/headroom.min.js" integrity="sha256-DJFC1kqIhelURkuza0AvYal5RxMtpzLjFhsnVIeuk+U=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.9.4/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><meta property="og:title" content="QC analysis via peaks detection">
<meta property="og:description" content="">
<meta property="og:image" content="caravagn.github.io/revolver/logo.png">
<meta name="twitter:card" content="summary">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body>
    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">CNAqc</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="Released version">0.1.0</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../index.html">
    <span class="fas fa fas fa-home fa-lg"></span>
     
  </a>
</li>
<li>
  <a href="../articles/CNAqc.html">Get started</a>
</li>
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Articles
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/Introduction.html">Introduction</a>
    </li>
    <li>
      <a href="../articles/ccf_computation.html">Computation of Cancer Cell Fractions</a>
    </li>
    <li>
      <a href="../articles/fragmentation.html">Genome fragmentation analysis</a>
    </li>
    <li>
      <a href="../articles/peaks_detection.html">QC analysis via peaks detection</a>
    </li>
    <li>
      <a href="../articles/smoothing.html">Smoothing copy number segments</a>
    </li>
  </ul>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a href="https://github.com/caravagn/CNAqc">
    <span class="fab fa fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      

      </header><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1>QC analysis via peaks detection</h1>
            
      
      <small class="dont-index">Source: <a href="https://github.com/caravagn/CNAqc/blob/master/vignettes/peaks_detection.Rmd"><code>vignettes/peaks_detection.Rmd</code></a></small>
      <div class="hidden name"><code>peaks_detection.Rmd</code></div>

    </div>

    
    
<p><code>CNAqc</code> can determine if purity and CNA segments “fit well” to mutation data, an hortogonal quality check (QC) metric that can be used to adjust purity/ ploidy.</p>
<p><code>CNAqc</code> matches allelic imbalance of CNA segments to the allelic frequencies of somatic mutations. The package implements a karyotype-weighted linear score which uses the distance between data peaks (empirical), and their theoretical expectation. This score accouts for normal plodiy (germline), and tumour purity/ ploidy. The peaks are determined via kernel density estimation and peak-detection heuristics.</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb1-1" data-line-number="1"><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span>(CNAqc)</a>
<a class="sourceLine" id="cb1-2" data-line-number="2"><span class="co">#&gt; ✓ Loading CNAqc, 'Copy Number Alteration quality check'. Support : &lt;https://caravagn.github.io/CNAqc/&gt;</span></a></code></pre></div>
<p>We work with the <a href="https://caravagn.github.io/CNAqc/articles/Introduction.html">template dataset</a>.</p>
<p>Peak detection routines can are implemented in function <code>analyze_peaks</code>.</p>
<p>The idea is as follows: a segment with <span class="math inline">\(m\)</span> and <span class="math inline">\(M\)</span> copies of the minor and major alleles is consistent to mutation data if the VAF distribution peaks at certain values, which we can compute. Profiling then of the VAF distribution with a peak-detection heuristic allows <code>CNAqc</code> to measure the if peaks match. Large deviance suggests usually wrong purity estimation.</p>
<div class="sourceCode" id="cb2"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb2-1" data-line-number="1"><span class="co"># Run default analysis</span></a>
<a class="sourceLine" id="cb2-2" data-line-number="2">x =<span class="st"> </span><span class="kw"><a href="../reference/analyze_peaks.html">analyze_peaks</a></span>(x)</a>
<a class="sourceLine" id="cb2-3" data-line-number="3"><span class="co">#&gt;  [ QC analysis with peaks detection ]</span></a>
<a class="sourceLine" id="cb2-4" data-line-number="4"><span class="co">#&gt; ── [ CNAqc ]  n = 13141 mutations in 267 segments (267 clonal + 0 subclonal) ──────────────────────────────────────────</span></a>
<a class="sourceLine" id="cb2-5" data-line-number="5"><span class="co">#&gt; ℹ Purity: 89% ~ Ploidy: 4.</span></a>
<a class="sourceLine" id="cb2-6" data-line-number="6"><span class="co">#&gt; ℹ Mutation mapping (head): 7478 (2:2); 1893 (4:2); 1625 (3:2); 1563 (2:1); 312 (3:0); 81 (2:0)</span></a>
<a class="sourceLine" id="cb2-7" data-line-number="7"><span class="co">#&gt; </span></a>
<a class="sourceLine" id="cb2-8" data-line-number="8"><span class="co">#&gt; =-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-</span></a>
<a class="sourceLine" id="cb2-9" data-line-number="9"><span class="co">#&gt;  Analysing ~ karyotypes 1:0, 1:1, 2:1, 2:0, 2:2 ~  9041 mutations ~ min. k = 657</span></a>
<a class="sourceLine" id="cb2-10" data-line-number="10"><span class="co">#&gt; =-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-</span></a>
<a class="sourceLine" id="cb2-11" data-line-number="11"><span class="co">#&gt; # A tibble: 3 x 5</span></a>
<a class="sourceLine" id="cb2-12" data-line-number="12"><span class="co">#&gt;   karyotype     n n_proportion QC    norm_prop</span></a>
<a class="sourceLine" id="cb2-13" data-line-number="13"><span class="co">#&gt;   &lt;chr&gt;     &lt;int&gt;        &lt;dbl&gt; &lt;lgl&gt;     &lt;dbl&gt;</span></a>
<a class="sourceLine" id="cb2-14" data-line-number="14"><span class="co">#&gt; 1 2:2        7478      0.569   TRUE      0.827</span></a>
<a class="sourceLine" id="cb2-15" data-line-number="15"><span class="co">#&gt; 2 2:1        1563      0.119   TRUE      0.173</span></a>
<a class="sourceLine" id="cb2-16" data-line-number="16"><span class="co">#&gt; 3 2:0          81      0.00616 FALSE    NA    </span></a>
<a class="sourceLine" id="cb2-17" data-line-number="17"><span class="co">#&gt; </span></a>
<a class="sourceLine" id="cb2-18" data-line-number="18"><span class="co">#&gt; Peak detector p = 0.89 ~ KDE a = 1 c = 0.5 ~ peakPick n = 1 epsilon = 0.015 </span></a>
<a class="sourceLine" id="cb2-19" data-line-number="19"><span class="co">#&gt; </span></a>
<a class="sourceLine" id="cb2-20" data-line-number="20"><span class="co">#&gt; =-=-=-=-=-=-=-=-</span></a>
<a class="sourceLine" id="cb2-21" data-line-number="21"><span class="co">#&gt;  Results table</span></a>
<a class="sourceLine" id="cb2-22" data-line-number="22"><span class="co">#&gt; =-=-=-=-=-=-=-=-</span></a>
<a class="sourceLine" id="cb2-23" data-line-number="23"><span class="co">#&gt; # A tibble: 4 x 10</span></a>
<a class="sourceLine" id="cb2-24" data-line-number="24"><span class="co">#&gt;   mutation_multip… karyotype  peak     x     y discarded   offset matched weight</span></a>
<a class="sourceLine" id="cb2-25" data-line-number="25"><span class="co">#&gt;              &lt;dbl&gt; &lt;chr&gt;     &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;lgl&gt;        &lt;dbl&gt; &lt;lgl&gt;    &lt;dbl&gt;</span></a>
<a class="sourceLine" id="cb2-26" data-line-number="26"><span class="co">#&gt; 1                2 2:1       0.616  0.6   2.94 FALSE      0.0159  FALSE   0.0864</span></a>
<a class="sourceLine" id="cb2-27" data-line-number="27"><span class="co">#&gt; 2                1 2:1       0.308  0.3   3.6  FALSE      0.00796 TRUE    0.0864</span></a>
<a class="sourceLine" id="cb2-28" data-line-number="28"><span class="co">#&gt; 3                2 2:2       0.471  0.46  8.14 FALSE      0.0109  TRUE    0.414 </span></a>
<a class="sourceLine" id="cb2-29" data-line-number="29"><span class="co">#&gt; 4                1 2:2       0.235  0.24  0.86 FALSE     -0.00455 TRUE    0.414 </span></a>
<a class="sourceLine" id="cb2-30" data-line-number="30"><span class="co">#&gt; # … with 1 more variable: score &lt;dbl&gt;</span></a>
<a class="sourceLine" id="cb2-31" data-line-number="31"><span class="co">#&gt; </span></a>
<a class="sourceLine" id="cb2-32" data-line-number="32"><span class="co">#&gt; Fit score: 0.00468956233367035 </span></a>
<a class="sourceLine" id="cb2-33" data-line-number="33"><span class="co">#&gt; </span></a></code></pre></div>
<p><code>CNAqc</code> analyze LOH regions (A, AA), diploid regions (AB), and amplification regions (AAB, AABB). These correspond to <code>'1:1'</code>, <code>'2:1'</code>, <code>'2:0'</code> and <code>'2:2'</code> in “Major:minor” notation. Karyotypes are subset by their size (normalized for the number of input mutations), and by default karyotypes smaller than 5% of the actual mutational burden are not considered</p>
<p>A Kernel-density method (unitary adjustment, Gaussian kernel) is used to smooth the data distribution, and the <code>peakPick</code> package to determine peaks in the smoothed density. Peaks below a mnimum density (noise and miscalled segments) are filtered, and the others are matched to a predefined location with some tolerance (e.g., plus/minus <code>0.5 * epsilon</code>, where <code>epsilon = 0.015</code> is the default).</p>
<p>Theis analysis produces a set of scores that account for karyotype size and peaks offset, and that can be combined into a linear model to compute an overall QC metrics, called <code>rho</code>.</p>
<div class="sourceCode" id="cb3"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb3-1" data-line-number="1"><span class="kw"><a href="https://rdrr.io/r/base/print.html">print</a></span>(x)</a>
<a class="sourceLine" id="cb3-2" data-line-number="2"><span class="co">#&gt; ── [ CNAqc ]  n = 13141 mutations in 267 segments (267 clonal + 0 subclonal) ──────────────────────────────────────────</span></a>
<a class="sourceLine" id="cb3-3" data-line-number="3"><span class="co">#&gt; ℹ Purity: 89% ~ Ploidy: 4.</span></a>
<a class="sourceLine" id="cb3-4" data-line-number="4"><span class="co">#&gt; ℹ Mutation mapping (head): 7478 (2:2); 1893 (4:2); 1625 (3:2); 1563 (2:1); 312 (3:0); 81 (2:0)</span></a>
<a class="sourceLine" id="cb3-5" data-line-number="5"><span class="co">#&gt; ✓ QC via peak detection available, score: 0.00468956233367035.</span></a>
<a class="sourceLine" id="cb3-6" data-line-number="6"><span class="co">#&gt; # A tibble: 4 x 10</span></a>
<a class="sourceLine" id="cb3-7" data-line-number="7"><span class="co">#&gt;   mutation_multip… karyotype  peak     x     y discarded   offset matched weight</span></a>
<a class="sourceLine" id="cb3-8" data-line-number="8"><span class="co">#&gt;              &lt;dbl&gt; &lt;chr&gt;     &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;lgl&gt;        &lt;dbl&gt; &lt;lgl&gt;    &lt;dbl&gt;</span></a>
<a class="sourceLine" id="cb3-9" data-line-number="9"><span class="co">#&gt; 1                2 2:1       0.616  0.6   2.94 FALSE      0.0159  FALSE   0.0864</span></a>
<a class="sourceLine" id="cb3-10" data-line-number="10"><span class="co">#&gt; 2                1 2:1       0.308  0.3   3.6  FALSE      0.00796 TRUE    0.0864</span></a>
<a class="sourceLine" id="cb3-11" data-line-number="11"><span class="co">#&gt; 3                2 2:2       0.471  0.46  8.14 FALSE      0.0109  TRUE    0.414 </span></a>
<a class="sourceLine" id="cb3-12" data-line-number="12"><span class="co">#&gt; 4                1 2:2       0.235  0.24  0.86 FALSE     -0.00455 TRUE    0.414 </span></a>
<a class="sourceLine" id="cb3-13" data-line-number="13"><span class="co">#&gt; # … with 1 more variable: score &lt;dbl&gt;</span></a></code></pre></div>
<p>A summary table is stored inside the named list <code>peaks_analysis</code>.</p>
<div id="plotting-results" class="section level3">
<h3 class="hasAnchor">
<a href="#plotting-results" class="anchor"></a>Plotting results</h3>
<p>For every karyotype, a plot with the estimated KDE and the matched peaks is available (assembled <code>ggpubr</code> figure with); gray panels represent karyotypes that have not been used.</p>
<div class="sourceCode" id="cb4"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb4-1" data-line-number="1"><span class="kw"><a href="../reference/plot_peaks_analysis.html">plot_peaks_analysis</a></span>(x)</a>
<a class="sourceLine" id="cb4-2" data-line-number="2"><span class="co">#&gt; Warning: Removed 2 rows containing missing values (geom_bar).</span></a>
<a class="sourceLine" id="cb4-3" data-line-number="3"><span class="co">#&gt; Warning: Removed 32 rows containing missing values (geom_path).</span></a>
<a class="sourceLine" id="cb4-4" data-line-number="4"><span class="co">#&gt; Warning: Removed 2 rows containing missing values (geom_bar).</span></a>
<a class="sourceLine" id="cb4-5" data-line-number="5"><span class="co">#&gt; Warning: Removed 13 rows containing missing values (geom_path).</span></a></code></pre></div>
<p><img src="peaks_detection_files/figure-html/unnamed-chunk-5-1.png" width="1056"></p>
<p>Individual karyotypes plots are available inside the named lists <code>peaks_analysis$plots</code>, named afte each required karyotype.</p>
<div class="sourceCode" id="cb5"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb5-1" data-line-number="1"><span class="co"># Tetraploid segments</span></a>
<a class="sourceLine" id="cb5-2" data-line-number="2">x<span class="op">$</span>peaks_analysis<span class="op">$</span>plots<span class="op">$</span><span class="st">`</span><span class="dt">2:2</span><span class="st">`</span></a>
<a class="sourceLine" id="cb5-3" data-line-number="3"><span class="co">#&gt; Warning: Removed 2 rows containing missing values (geom_bar).</span></a>
<a class="sourceLine" id="cb5-4" data-line-number="4"><span class="co">#&gt; Warning: Removed 13 rows containing missing values (geom_path).</span></a></code></pre></div>
<p><img src="peaks_detection_files/figure-html/unnamed-chunk-6-1.png" width="288"></p>
<p>You can integrate plots from QC analysis with data.</p>
<div class="sourceCode" id="cb6"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb6-1" data-line-number="1">cowplot<span class="op">::</span><span class="kw"><a href="https://rdrr.io/pkg/cowplot/man/plot_grid.html">plot_grid</a></span>(</a>
<a class="sourceLine" id="cb6-2" data-line-number="2">  <span class="kw"><a href="../reference/plot_peaks_analysis.html">plot_peaks_analysis</a></span>(x),</a>
<a class="sourceLine" id="cb6-3" data-line-number="3">  <span class="kw"><a href="../reference/plot_segments.html">plot_segments</a></span>(x),</a>
<a class="sourceLine" id="cb6-4" data-line-number="4">  <span class="dt">rel_heights =</span> <span class="kw"><a href="https://rdrr.io/r/base/c.html">c</a></span>(.<span class="dv">8</span>, <span class="dv">1</span>),</a>
<a class="sourceLine" id="cb6-5" data-line-number="5">  <span class="dt">nrow =</span> <span class="dv">2</span></a>
<a class="sourceLine" id="cb6-6" data-line-number="6">)</a>
<a class="sourceLine" id="cb6-7" data-line-number="7"><span class="co">#&gt; Warning: Removed 2 rows containing missing values (geom_bar).</span></a>
<a class="sourceLine" id="cb6-8" data-line-number="8"><span class="co">#&gt; Warning: Removed 32 rows containing missing values (geom_path).</span></a>
<a class="sourceLine" id="cb6-9" data-line-number="9"><span class="co">#&gt; Warning: Removed 2 rows containing missing values (geom_bar).</span></a>
<a class="sourceLine" id="cb6-10" data-line-number="10"><span class="co">#&gt; Warning: Removed 13 rows containing missing values (geom_path).</span></a>
<a class="sourceLine" id="cb6-11" data-line-number="11"><span class="co">#&gt; Warning in plot_segments(x): Segments with CN above 8 will not be plot; this is</span></a>
<a class="sourceLine" id="cb6-12" data-line-number="12"><span class="co">#&gt; annotated in the figure.</span></a>
<a class="sourceLine" id="cb6-13" data-line-number="13"><span class="co">#&gt; Warning: Removed 10 rows containing missing values (geom_segment).</span></a></code></pre></div>
<p><img src="peaks_detection_files/figure-html/unnamed-chunk-7-1.png" width="1056"></p>
<p>You can visually summarise the result of the QC analysis, which reports the peaks matched to data, the karyotype size (re-normalized for the karyotypes used) and the overall score.</p>
<div class="sourceCode" id="cb7"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb7-1" data-line-number="1"><span class="kw"><a href="../reference/plot_qc.html">plot_qc</a></span>(x)</a></code></pre></div>
<p><img src="peaks_detection_files/figure-html/unnamed-chunk-8-1.png" width="480"></p>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="sidebar">

      </div>

</div>



      <footer><div class="copyright">
  <p>Developed by <a href="https://sites.google.com/site/giuliocaravagna/">Giulio Caravagna</a>.</p>
</div>

<div class="pkgdown">
  <p>Site built with <a href="https://pkgdown.r-lib.org/">pkgdown</a> 1.4.1.</p>
</div>

      </footer>
</div>

  


  </body>
</html>

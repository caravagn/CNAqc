---
title: "QC analysis via peaks detection"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{QC analysis via peaks detection}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

```{r setup}
library(CNAqc)
require(tidyverse)
```

We work with the same object shown in the [introductory vignette](file:///Users/gcaravagna/Documents/GitHub/CNAqc/docs/articles/CNAqc.html). 

```{r echo=TRUE, results=FALSE}
# Dataset available with the package -- see Get Started.
data('example_dataset_CNAqc', package = 'CNAqc')
x = CNAqc::init(example_dataset_CNAqc$snvs, example_dataset_CNAqc$cna,example_dataset_CNAqc$purity)
```


Peak detection routines can be used to determine the QC of the CNA calls, and are implemented in function `analyze_peaks`. 

Essentially, the logic is that if a certain segment has truly the number of copies of the major and minor alleles that we
have estimated, then we should see this also in the VAF distribution for those very same mutations. Using standard principles
of Copy Number analysis we can compute, as a function of the estimated purity and the major/ minor of a segment, where we expect 
to see a certain group of mutations. This kind of signal is picked up examining the profile of the VAF distribution, and using
a peak-detection heuristic to match peaks in the data to their expectation.

Because peaks are estimated from data, we can measure in a quantitative way how off data are with respect to the theoretical
predictions. A large deviance suggests usually wrong purity estimation, which in turns affects the calling of CNA segments.
Therefore, with the measurement available it is possible to determine how much the purity should be adjusted to achieve a 
better fit of the input data.


```{r, fig.width=11, fig.height=3}
# Run default analysis
x = analyze_peaks(x)
```

The default analysis does:

* analyze  LOH regions (A, AA), diploid regions (AB), and amplification regions (AAB, AABB). These correspond to
`'1:1'`, `'2:1'`, `'2:0'` and `'2:2'` in "Major:minor" notation. Karyotypes are subset by their size (normalized for
the number of input mutations), and by default Karyotypes smaller than 5% of the actual mutational burden are not considered;

* uses a KDE methods with unitary adjustment and Gaussian kernel;

* uses the `peakPick` package to determine peaks in the KDE smooth of the VAF distribution, subsetting peaks below a mnimum 
density which could be due to noise and miscalled CNAs. Peaks at a certain location are matched with a range of plus/minus 
`0.5 * epsilon`, where `epsilon` is a pre-defined value which by default is `0.015`.

The results of this analysis is a set of scores that account for karyotype size and peaks offset, and that are combined into
a linear model to compute an overall QC metrics, called `rho`.

A summary table is available after the computatio, and is stored inside the named list `peaks_analysis`.
```{r, fig.width=11, fig.height=3}
print(x)
```

### Plotting results of the analysis

You can visually summarise the result of the QC analysis, which reports the peaks matched to data, the karyotype size
(re-normalized for the karyotypes used) and the overall score.   

```{r, fig.width=3.5, fig.height=3.5}
plot_qc(x)
```

For every karyotype that you have tested, a plot is available for its peak detection's analysis, which shows the 
estimated KDE and the matched peaks. This plot is assembled as a `ggpubr` figure with all the `ggplot` outputs; notice
that the fits for the karyotypes that have not been used, but that were passed through parameter `karyotypes of function
`analyze_peaks`, are just gray panels.

```{r, fig.width=11, fig.height=3}
plot_peaks_analysis(x)
```

Individual karyotypes plots are available inside the named lists `peaks_analysis$plots`, named afte each required
karyotype.

```{r, fig.width=3, fig.height=3}
# Diploid segments
x$peaks_analysis$plots$`1:1`

# Tetraploid segments
x$peaks_analysis$plots$`2:2`
```

You can integrate plots from QC analysis with data; in this case we combine them with segments.
```{r, fig.width=11, fig.height=7}
cowplot::plot_grid(
  plot_peaks_analysis(x),
  plot_segments(x) + ylim(-1, 6),
  rel_heights = c(.8, 1),
  nrow = 2
)
```

